<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - CASAQR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    
    <style>
        /* Barras de rolagem mais bonitas */
        .custom-scrollbar::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 font-sans pb-20">

    <nav class="bg-slate-900 text-white p-4 px-8 flex justify-between items-center shadow-lg sticky top-0 z-50">
        <div class="font-black italic text-xl">CASAQR <span class="text-blue-400">ADMIN</span></div>
        <div class="flex gap-3">
            <a href="validador.html" target="_blank" class="px-4 py-2 bg-green-600 rounded-lg text-xs font-bold hover:bg-green-500 transition border border-green-400">üì≤ Abrir Validador</a>
            <a href="index.html" target="_blank" class="px-4 py-2 bg-blue-600 rounded-lg text-xs font-bold hover:bg-blue-500 transition">üëÄ Ver P√°gina de ingressos</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8 mt-4">

        <div class="space-y-6">
            
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-black text-slate-800 text-lg mb-4 flex items-center gap-2">üìÖ Criar Evento</h3>
                <div class="space-y-3">
                    <input id="evNome" type="text" placeholder="Nome do Evento" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    <input id="evData" type="text" placeholder="Data (Ex: 25/10)" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    
                    <div class="grid grid-cols-2 gap-2">
                        <div class="relative">
                            <label class="text-[10px] font-bold text-gray-400 absolute top-1 left-2">ESTOQUE AVULSO</label>
                            <input id="evEstoque" type="number" placeholder="Ex: 300" class="w-full pt-5 pb-2 px-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500 font-bold text-blue-900">
                        </div>
                        <div class="relative">
                            <label class="text-[10px] font-bold text-gray-400 absolute top-1 left-2">QTD POR ALUNO</label>
                            <input id="evQtd" type="number" placeholder="Ex: 2" value="1" min="1" class="w-full pt-5 pb-2 px-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500 font-bold text-blue-900">
                        </div>
                    </div>

                    <input id="evImg" type="text" placeholder="Link da Imagem (URL)" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    <input id="evBg" type="text" placeholder="Link Fundo PDF (Opcional)" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    
                    <div class="p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                       //ATIVA SE PEDIREM - LINHA 57 , 58
                        <!--<p class="text-xs font-bold text-yellow-700 mb-1">√â pago?</p>-->
                      <!--  <input id="evZap" type="text" placeholder="Zap (5511999...)" class="w-full bg-white p-2 rounded-lg text-sm outline-none border border-yellow-300">-->
                    </div>
                    <button onclick="salvarEvento()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition">Salvar (Inicia Bloqueado üîí)</button>
                </div>
            </div>

            <div class="bg-green-50 p-6 rounded-3xl border border-green-100">
                <h3 class="font-black text-green-800 text-lg mb-4 flex items-center gap-2">üìÇ Banco de Alunos</h3>
                <textarea id="jsonAlunos" rows="3" class="w-full p-3 rounded-xl text-xs font-mono outline-none border border-green-200" placeholder='Cole o JSON aqui...'></textarea>
                <button onclick="importarAlunos()" class="w-full mt-2 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">Importar Lista</button>
            </div>

            <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100 relative">
                <h3 class="font-black text-blue-800 text-lg mb-4 flex items-center gap-2">üéüÔ∏è Ingresso Avulso</h3>
                
                <div id="avulsoInfo" class="hidden mb-3 p-2 bg-white rounded border border-blue-200 text-xs text-blue-800 font-bold text-center">
                    Selecione um evento
                </div>

                <div class="space-y-3">
                    <select id="selEventos" onchange="atualizarInfoEstoque()" class="w-full p-3 bg-white rounded-xl text-sm outline-none text-slate-700 font-bold">
                        <option value="">Selecione o Evento...</option>
                    </select>
                    
                    <div class="flex gap-2">
                        <div class="w-2/3">
                            <input id="avMat" type="number" placeholder="Matr√≠cula" class="w-full p-3 bg-white rounded-xl text-sm outline-none" onblur="buscarAlunoAvulso(this.value)">
                        </div>
                        <div class="w-1/3 relative">
                            <label class="absolute -top-2 left-2 bg-blue-100 px-1 text-[10px] font-bold text-blue-800 rounded">QTD</label>
                            <input id="avQtdGerar" type="number" value="1" min="1" max="100" class="w-full p-3 bg-white rounded-xl text-sm outline-none font-bold text-center border border-blue-200 text-blue-900">
                        </div>
                    </div>

                    <input id="avAluno" type="text" placeholder="Nome" class="w-full p-3 bg-white rounded-xl text-sm outline-none font-bold text-blue-800">
                    <input id="avResp" type="text" placeholder="Respons√°vel" class="w-full p-3 bg-white rounded-xl text-sm outline-none">
                    
                    <button onclick="gerarAvulso()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition shadow-lg shadow-blue-200">
                        Gerar Ingressos
                    </button>
                </div>
            </div>
        </div>

        <div class="lg:col-span-2 space-y-6">
            
            <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200 flex flex-col h-[350px]">
                <h4 class="font-bold text-slate-700 mb-2 text-sm uppercase px-2 shrink-0">Gerenciar Eventos (Lista)</h4>
                
                <div class="overflow-hidden flex flex-col flex-1 border border-gray-100 rounded-lg">
                    <div class="bg-gray-100 text-xs uppercase text-gray-500 font-bold flex shrink-0">
                        <div class="p-3 w-5/12">Evento</div>
                        <div class="p-3 w-3/12">Vendas</div>
                        <div class="p-3 w-2/12 text-center">Status</div>
                        <div class="p-3 w-2/12 text-right">A√ß√£o</div>
                    </div>
                    
                    <div class="overflow-y-auto custom-scrollbar flex-1 bg-white">
                        <table class="w-full text-left text-sm text-gray-600">
                            <tbody id="listaEventosTabela" class="divide-y divide-gray-100">
                                <tr><td colspan="4" class="p-4 text-center text-xs">Carregando eventos...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 flex flex-col h-[600px]"> 
                <div class="p-6 border-b border-gray-100 flex justify-between items-center shrink-0">
                    <div>
                        <h3 class="font-black text-slate-800 text-lg">Ingressos Emitidos</h3>
                        <p class="text-xs text-gray-400 font-bold mt-1">
                            Total: <span id="totalGeral">0</span> | 
                            Avulsos: <span id="totalAvulsos" class="text-blue-600">0</span> | 
                            Validados: <span id="totalValidados" class="text-green-600">0</span>
                        </p>
                    </div>
                    <input type="text" id="busca" onkeyup="filtrarTabela()" placeholder="üîç Buscar nome..." class="p-2 bg-gray-50 rounded-lg text-sm border focus:ring-2 ring-blue-500 outline-none w-48">
                </div>
                
                <div class="overflow-y-auto overflow-x-auto flex-1 custom-scrollbar">
                    <table class="w-full text-left text-sm text-gray-600">
                        <thead class="bg-gray-50 text-xs uppercase text-gray-400 font-bold sticky top-0 z-10">
                            <tr>
                                <th class="p-4 bg-gray-50">Aluno</th>
                                <th class="p-4 bg-gray-50">Evento</th>
                                <th class="p-4 bg-gray-50">Tipo</th>
                                <th class="p-4 bg-gray-50 text-center">Status</th>
                                <th class="p-4 bg-gray-50 text-right">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="tabelaIngressos" class="divide-y divide-gray-100">
                            <tr><td class="p-4">Carregando dados...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyBFDlEOhuUerWjSfK_mPVxoj5sGbSDhe9k", 
            authDomain: "ingressoscdc-9ce88.firebaseapp.com", 
            databaseURL: "https://ingressoscdc-9ce88-default-rtdb.firebaseio.com", 
            projectId: "ingressoscdc-9ce88", 
            storageBucket: "ingressoscdc-9ce88.firebasestorage.app", 
            messagingSenderId: "976193676383", 
            appId: "1:976193676383:web:8f141a1bd705f8bc0ae7ea" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        emailjs.init("RmJx_2rhtntD90vsH");

        let todosEventos = {}; 
        let todosIngressos = [];
        let contagemAvulsosPorEvento = {}; 

        // 1. CARREGAR DADOS
        function carregarTudo() {
            // Listener de Eventos
            db.ref('eventos').on('value', snapEventos => {
                todosEventos = {};
                if(snapEventos.exists()) {
                    snapEventos.forEach(child => {
                        todosEventos[child.key] = { key: child.key, ...child.val() };
                    });
                }
                
                // Listener de Ingressos (s√≥ atualiza a tela depois de ter os ingressos para contar o estoque)
                db.ref('ingressos').on('value', snapIngressos => {
                    todosIngressos = [];
                    contagemAvulsosPorEvento = {}; 
                    if(snapIngressos.exists()) {
                        snapIngressos.forEach(i => {
                            const ing = { key: i.key, ...i.val() };
                            todosIngressos.push(ing);
                            
                            // Contagem de estoque
                            if(ing.tipo === 'Avulso') {
                                if(!contagemAvulsosPorEvento[ing.evento]) contagemAvulsosPorEvento[ing.evento] = 0;
                                contagemAvulsosPorEvento[ing.evento]++;
                            }
                        });
                    }
                    atualizarUIEventos(); // Atualiza a lista de eventos
                    renderizarTabelaIngressos(todosIngressos); // Atualiza a tabela de ingressos
                    atualizarInfoEstoque(); // Atualiza o select
                });
            });
        }
        carregarTudo();

        // 2. ATUALIZAR LISTA DE EVENTOS (L√≥gica corrigida para garantir que TODOS apare√ßam)
        function atualizarUIEventos() {
            const tbodyEventos = document.getElementById('listaEventosTabela');
            const sel = document.getElementById('selEventos');
            const selecaoAtual = sel.value; 

            // Limpa o Select
            sel.innerHTML = '<option value="">Selecione o Evento...</option>';

            const eventosArray = Object.values(todosEventos);
            
            // Se n√£o tiver eventos
            if(eventosArray.length === 0) { 
                tbodyEventos.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-xs text-gray-400'>Nenhum evento criado.</td></tr>"; 
                return; 
            }

            // Construir o HTML em uma vari√°vel primeiro (Mais r√°pido e seguro)
            let htmlTabela = "";

            eventosArray.forEach(ev => {
                // C√°lculos
                const vendidos = contagemAvulsosPorEvento[ev.nome] || 0;
                const limite = parseInt(ev.estoque) || 0;
                const disponivel = limite - vendidos;
                const statusTexto = limite > 0 ? `Restam ${Math.max(0, disponivel)}` : "Ilimitado";
                
                const isLiberado = ev.liberado === true;
                const btnClass = isLiberado ? 'bg-green-100 text-green-700 border-green-200' : 'bg-slate-100 text-slate-500 border-slate-200';
                const iconTrava = isLiberado ? 'üîì Aberto' : 'üîí Fechado';

                // Adiciona ao Select (Ingresso Avulso)
                const opt = document.createElement('option'); 
                opt.value = ev.nome; 
                opt.text = `${ev.nome} (${statusTexto})`; 
                sel.appendChild(opt);
                
                // Barra de Progresso
                let porcentagem = 0; let corBarra = 'bg-blue-600';
                if(limite > 0) {
                    porcentagem = Math.min((vendidos / limite) * 100, 100);
                    if(porcentagem >= 100) corBarra = 'bg-gray-800'; 
                    else if(porcentagem > 90) corBarra = 'bg-red-600';
                }

                // Adiciona √† string da Tabela (Gerenciar Eventos)
                htmlTabela += `
                <tr class="hover:bg-slate-50 transition group border-b border-gray-50">
                    <td class="p-3 w-5/12 align-middle">
                        <div class="font-bold text-slate-800 text-sm truncate" title="${ev.nome}">${ev.nome}</div>
                        <div class="text-[10px] text-gray-400 font-mono">${ev.data}</div>
                    </td>
                    <td class="p-3 w-3/12 align-middle">
                        <div class="flex justify-between text-[10px] mb-1 font-bold text-gray-500">
                            <span>${vendidos}</span>
                            <span>${limite>0 ? limite : '‚àû'}</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-1.5">
                            <div class="${corBarra} h-1.5 rounded-full" style="width: ${porcentagem}%"></div>
                        </div>
                    </td>
                    <td class="p-3 w-2/12 text-center align-middle">
                         <button onclick="alternarTrava('${ev.key}', ${isLiberado})" class="text-[10px] font-bold border px-2 py-1 rounded w-full ${btnClass} hover:opacity-80 transition">
                            ${iconTrava}
                        </button>
                    </td>
                    <td class="p-3 w-2/12 text-right align-middle">
                        <button onclick="excluirEvento('${ev.key}')" class="text-xs text-gray-300 hover:text-red-500 transition p-2 rounded-full hover:bg-red-50" title="Excluir">
                            üóëÔ∏è
                        </button>
                    </td>
                </tr>`;
            });

            // Injeta o HTML de uma vez s√≥
            tbodyEventos.innerHTML = htmlTabela;

            // Restaura a sele√ß√£o do dropdown se poss√≠vel
            if(selecaoAtual) sel.value = selecaoAtual;
        }

        function alternarTrava(key, statusAtual) {
            db.ref('eventos/'+key).update({ liberado: !statusAtual });
        }

        function atualizarInfoEstoque() {
            const nomeEvento = document.getElementById('selEventos').value;
            const divInfo = document.getElementById('avulsoInfo');
            if(!nomeEvento) { divInfo.classList.add('hidden'); return; }

            const evData = Object.values(todosEventos).find(e => e.nome === nomeEvento);
            if(evData) {
                const limite = parseInt(evData.estoque) || 0;
                const vendidos = contagemAvulsosPorEvento[nomeEvento] || 0;
                const restantes = limite - vendidos;
                divInfo.classList.remove('hidden');
                let textoStatus = !evData.liberado ? "<span class='block text-gray-500 mb-1'>üîí O Aluno v√™ 'EM BREVE'</span>" : "";
                if(limite > 0) {
                    if(restantes <= 0) divInfo.innerHTML = `${textoStatus}‚õî ESGOTADO! (${vendidos}/${limite})`;
                    else divInfo.innerHTML = `${textoStatus}‚úÖ DISPON√çVEIS: ${restantes} (Total: ${limite})`;
                } else {
                    divInfo.innerHTML = `${textoStatus}‚ôæÔ∏è Estoque Ilimitado`;
                }
            }
        }

        async function gerarAvulso() {
            const evNome = document.getElementById('selEventos').value;
            const al = document.getElementById('avAluno').value;
            const mt = document.getElementById('avMat').value;
            const rp = document.getElementById('avResp').value || "Escola";
            const qtd = parseInt(document.getElementById('avQtdGerar').value) || 1;

            if(!evNome || !al || !mt) return alert("Preencha todos os campos!");
            if(qtd < 1) return alert("M√≠nimo 1 ingresso.");
            const eventoObj = Object.values(todosEventos).find(e => e.nome === evNome);
            if(!eventoObj) return alert("Evento n√£o encontrado.");
            const limite = parseInt(eventoObj.estoque) || 0;
            const vendidos = contagemAvulsosPorEvento[evNome] || 0;
            const disponivel = limite - vendidos;
            if(limite > 0) {
                if((vendidos + qtd) > limite) {
                    alert(`‚õî ESTOQUE INSUFICIENTE!\nVoc√™ pediu ${qtd}, mas s√≥ restam ${Math.max(0, disponivel)} no estoque AVULSO.`);
                    return; 
                }
            }
            if(qtd > 5) alert("Gerando ingressos, aguarde...");
            const time = Date.now();
            for(let i = 0; i < qtd; i++) {
                const id = `${mt}-AVULSO-${time.toString().slice(-5)}${i}`; 
                await db.ref('ingressos/'+id).set({ 
                    aluno: al, 
                    matricula: mt, 
                    responsavel: rp, 
                    evento: evNome, 
                    utilizado: false, 
                    tipo: 'Avulso',
                    data: new Date().toISOString() 
                });
            }
            alert(`${qtd} ingresso(s) gerado(s)!`);
            document.getElementById('avQtdGerar').value = "1"; 
        }

        function salvarEvento() {
            const nome = document.getElementById('evNome').value; 
            const data = document.getElementById('evData').value;
            const estoque = document.getElementById('evEstoque').value; 
            const img = document.getElementById('evImg').value;
            const bgPdf = document.getElementById('evBg').value; 
            const zap = document.getElementById('evZap').value;
            const qtdPorAluno = document.getElementById('evQtd').value;

            if(!nome || !data) return alert("Preencha Nome e Data!");
            
            db.ref('eventos').push({ 
                nome, 
                data, 
                imagem: img, 
                bgPdf, 
                estoque: parseInt(estoque) || 0, 
                limit_ingressos: parseInt(qtdPorAluno) || 1, 
                contato: zap, 
                liberado: false 
            });
            alert("Evento Criado (Bloqueado)!"); location.reload();
        }

        function renderizarTabelaIngressos(lista) {
            const tbody = document.getElementById('tabelaIngressos'); tbody.innerHTML = "";
            let qtd = 0; 
            let avulsos = 0; 
            let validados = 0;

            if(lista.length === 0) { tbody.innerHTML = `<tr><td colspan="5" class="p-6 text-center text-gray-400">Nenhum ingresso.</td></tr>`; return; }

            lista.slice().reverse().forEach(ing => {
                qtd++; 
                if(ing.tipo === 'Avulso') avulsos++;
                if(ing.status === 'validado') validados++;

                const tipoBadge = ing.tipo === 'Avulso' 
                    ? '<span class="text-[10px] bg-purple-100 text-purple-700 px-2 py-1 rounded font-bold">AVULSO</span>' 
                    : '<span class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded font-bold">ALUNO</span>';

                let statusHtml = "";
                let rowColor = "border-b border-gray-50 hover:bg-slate-50"; 

                if (ing.status === 'validado') {
                    rowColor = "border-b border-green-50 bg-green-50/40 hover:bg-green-100/50"; 
                    const hora = ing.horario_validacao ? new Date(ing.horario_validacao).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '??:??';
                    statusHtml = `
                        <div class="flex flex-col items-center">
                            <span class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded border border-green-200 font-bold uppercase tracking-wide">‚úÖ Validado</span>
                            <span class="text-[10px] text-green-600 font-mono mt-1">${hora}</span>
                        </div>`;
                } else {
                    statusHtml = `<div class="flex justify-center"><span class="text-[10px] bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-100 font-bold uppercase tracking-wide">üéüÔ∏è Liberado</span></div>`;
                }

                tbody.innerHTML += `
                    <tr class="${rowColor} transition">
                        <td class="p-4"><div class="font-bold text-slate-800">${ing.aluno}</div><div class="text-xs text-slate-400 font-mono">#${ing.key}</div></td>
                        <td class="p-4"><span class="text-xs font-bold uppercase bg-gray-100 text-gray-600 px-2 py-1 rounded-md">${ing.evento}</span></td>
                        <td class="p-4">${tipoBadge}</td>
                        <td class="p-4 text-center">${statusHtml}</td>
                        <td class="p-4 text-right">
                            <button onclick="reenviarEmail('${ing.key}')" class="mr-2 text-slate-400 hover:text-purple-600 transition" title="Reenviar Email">üìß</button>
                            <button onclick="reimprimir('${ing.key}')" class="mr-2 text-slate-400 hover:text-blue-600 transition" title="Baixar Novamente">‚¨áÔ∏è</button>
                            <button onclick="excluirIngresso('${ing.key}')" class="text-slate-400 hover:text-red-500 transition" title="Excluir">üóëÔ∏è</button>
                        </td>
                    </tr>`;
            });
            document.getElementById('totalGeral').innerText = qtd; 
            document.getElementById('totalAvulsos').innerText = avulsos;
            document.getElementById('totalValidados').innerText = validados; 
        }

        async function reenviarEmail(key) {
            const ing = todosIngressos.find(i => i.key === key);
            if(!ing) return alert("Ingresso n√£o encontrado.");
            if(!ing.email) return alert("Este ingresso n√£o tem e-mail cadastrado (Avulso?).");

            if(!confirm(`Reenviar ingresso para: ${ing.email}?`)) return;

            const templateParams = {
                nome_aluno: ing.aluno,
                turma: ing.turma || "N/A",
                nome_responsavel: ing.responsavel,
                evento: ing.evento,
                codigo_ingresso: ing.key, 
                to_email: ing.email
            };

            emailjs.send("service_r1vrjkp", "template_4yvqw5g", templateParams)
                .then(() => alert("‚úÖ Email reenviado com sucesso!"))
                .catch((err) => alert("‚ùå Erro ao enviar: " + JSON.stringify(err)));
        }

        function excluirEvento(key) { if(confirm("Deseja excluir este evento?")) db.ref('eventos/'+key).remove(); }
        function excluirIngresso(key) { if(confirm("Apagar ingresso? Isso invalidar√° o QR Code.")) db.ref('ingressos/'+key).remove(); }
        function importarAlunos() { try { const lista = JSON.parse(document.getElementById('jsonAlunos').value); let ups = {}; lista.forEach(a => { if(a.matricula) ups['/alunos_db/'+a.matricula] = { nome: a.nome, turma: a.turma||"" }; }); db.ref().update(ups).then(()=>alert("Importado!")); } catch(e){ alert("JSON Inv√°lido"); } }
        async function buscarAlunoAvulso(mat) { if(!mat) return; const s = await db.ref('alunos_db/'+mat).once('value'); if(s.exists()) document.getElementById('avAluno').value = s.val().nome; }
        function filtrarTabela() { const v = document.getElementById('busca').value.toLowerCase(); document.querySelectorAll('#tabelaIngressos tr').forEach(r => r.style.display = r.innerText.toLowerCase().includes(v) ? '' : 'none'); }
        
        async function reimprimir(key) { 
            const t = todosIngressos.find(i => i.key === key);
            const evInfo = Object.values(todosEventos).find(e => e.nome === t.evento);
            const escala = 4; const larguraOriginal = 200; const alturaOriginal = 300; const w = larguraOriginal * escala; const h = alturaOriginal * escala;
            let bg = null; if(evInfo && evInfo.bgPdf) { bg = new Image(); bg.crossOrigin="anonymous"; bg.src = evInfo.bgPdf; await new Promise(r => { bg.onload=r; bg.onerror=r; }); }
            const c = document.createElement('canvas'); const x = c.getContext('2d'); c.width = w; c.height = h; 
            x.fillStyle='#fff'; x.fillRect(0,0,w,h);
            if(bg) { const ratio = Math.max(w/bg.width, h/bg.height); const centerShift_x = (w - bg.width*ratio) / 2; const centerShift_y = (h - bg.height*ratio) / 2; x.drawImage(bg, 0, 0, bg.width, bg.height, centerShift_x, centerShift_y, bg.width*ratio, bg.height*ratio); }
            x.fillStyle='rgba(255,255,255,0.95)'; x.beginPath(); x.roundRect(10*escala, 130*escala, 180*escala, 160*escala, 10*escala); x.fill();
            x.strokeStyle = '#e2e8f0'; x.lineWidth = 2 * escala; x.stroke();
            x.fillStyle='#000'; x.textAlign='center'; x.font = `bold ${12 * escala}px sans-serif`; x.fillText(t.evento.substring(0,25), w/2, 155 * escala);
            let fs = 18 * escala; x.font = `900 ${fs}px sans-serif`; x.fillStyle = '#1e293b'; const nomeUp = t.aluno.toUpperCase();
            while (x.measureText(nomeUp).width > (170 * escala) && fs > (8 * escala)) { fs -= escala; x.font = `900 ${fs}px sans-serif`; }
            x.fillText(nomeUp, w/2, 185 * escala);
            x.font = `${10 * escala}px monospace`; x.fillStyle='#64748b'; x.fillText(key, w/2, 205 * escala);
            const q = document.createElement('div'); const qrSize = 80 * escala;
            new QRCode(q, { text: key, width: qrSize, height: qrSize, colorDark: "#000000", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H }); 
            await new Promise(r=>setTimeout(r, 200));
            const canvasQr = q.querySelector('canvas');
            if(canvasQr) { x.drawImage(canvasQr, (w - qrSize)/2, 215 * escala); }
            const link = document.createElement('a'); link.href = c.toDataURL('image/jpeg', 1.0); link.download = `Ingresso-${t.aluno.replace(/\s+/g, '_')}.jpg`; link.click();
        }
    </script>
</body>
</html>

