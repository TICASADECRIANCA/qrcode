<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - ESCOLAPRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-gray-50 font-sans">

    <nav class="bg-slate-900 p-4 text-white flex justify-between items-center shadow-md">
        <h1 class="text-xl font-bold italic">ADMIN ESCOLAPRO</h1>
        <div>
            <a href="index.html" class="text-sm text-gray-400 hover:text-white mr-4">Ir para Site</a>
            <a href="cadastrar_evento.html" class="bg-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-500 text-sm">Novo Evento</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-2 gap-8">
        
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h2 class="text-xl font-black text-slate-800 mb-4 border-b pb-2">üìÖ Gerenciar Eventos</h2>
            <div id="listaEventos" class="space-y-3">
                <p class="text-gray-400 text-center py-4">Carregando...</p>
            </div>
        </div>

        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-200">
            <h2 class="text-xl font-black text-slate-800 mb-4 border-b pb-2">üéüÔ∏è Gerenciar Ingressos</h2>
            
            <div class="flex gap-2 mb-4">
                <input type="text" id="buscaIngresso" placeholder="Buscar aluno ou matr√≠cula..." class="w-full border p-2 rounded-lg text-sm" onkeyup="filtrarIngressos()">
            </div>

            <div class="overflow-y-auto max-h-[500px]">
                <table class="w-full text-left text-sm">
                    <thead class="bg-gray-100 text-gray-600 sticky top-0">
                        <tr>
                            <th class="p-3">ID</th>
                            <th class="p-3">Aluno</th>
                            <th class="p-3">Evento</th>
                            <th class="p-3 text-right">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="listaIngressos"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = { 
            apiKey: "AIzaSyBFDlEOhuUerWjSfK_mPVxoj5sGbSDhe9k", 
            authDomain: "ingressoscdc-9ce88.firebaseapp.com", 
            databaseURL: "https://ingressoscdc-9ce88-default-rtdb.firebaseio.com", 
            projectId: "ingressoscdc-9ce88", 
            storageBucket: "ingressoscdc-9ce88.firebasestorage.app", 
            messagingSenderId: "976193676383", 
            appId: "1:976193676383:web:8f141a1bd705f8bc0ae7ea" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        emailjs.init("RmJx_2rhtntD90vsH");

        // --- CARREGAR EVENTOS ---
        db.ref('eventos').on('value', snap => {
            const div = document.getElementById('listaEventos'); div.innerHTML = "";
            if(!snap.exists()){ div.innerHTML = "<p>Nenhum evento.</p>"; return; }
            
            snap.forEach(i => {
                const ev = i.val();
                div.innerHTML += `
                <div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl border hover:bg-white transition">
                    <div>
                        <p class="font-bold text-slate-800">${ev.nome}</p>
                        <p class="text-xs text-blue-500 font-bold uppercase">${ev.data}</p>
                    </div>
                    <button onclick="excluirEvento('${i.key}')" class="bg-red-100 text-red-600 px-3 py-1 rounded-lg text-xs font-bold hover:bg-red-200">Excluir</button>
                </div>`;
            });
        });

        // --- CARREGAR INGRESSOS ---
        let todosIngressos = [];
        db.ref('ingressos').on('value', snap => {
            todosIngressos = [];
            if(snap.exists()) {
                snap.forEach(i => {
                    todosIngressos.push({ key: i.key, ...i.val() });
                });
            }
            renderizarIngressos(todosIngressos);
        });

        function renderizarIngressos(lista) {
            const tb = document.getElementById('listaIngressos'); tb.innerHTML = "";
            if(lista.length === 0) { tb.innerHTML = "<tr><td colspan='4' class='p-4 text-center text-gray-400'>Nada encontrado.</td></tr>"; return; }

            // Ordena os mais recentes primeiro
            lista.reverse().forEach(t => {
                tb.innerHTML += `
                <tr class="border-b hover:bg-blue-50">
                    <td class="p-3 font-mono text-xs text-gray-500">${t.key}</td>
                    <td class="p-3 font-bold">${t.aluno}</td>
                    <td class="p-3 text-xs">${t.evento}</td>
                    <td class="p-3 text-right space-x-1">
                        <button onclick="reenviarEmail('${t.key}')" class="text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold hover:bg-green-200">‚úâÔ∏è Enviar</button>
                        <button onclick="excluirIngresso('${t.key}')" class="text-[10px] bg-red-100 text-red-600 px-2 py-1 rounded font-bold hover:bg-red-200">üóëÔ∏è</button>
                    </td>
                </tr>`;
            });
        }

        function filtrarIngressos() {
            const termo = document.getElementById('buscaIngresso').value.toLowerCase();
            const filtrados = todosIngressos.filter(t => 
                (t.aluno && t.aluno.toLowerCase().includes(termo)) || 
                (t.matricula && t.matricula.includes(termo)) ||
                (t.key && t.key.includes(termo))
            );
            renderizarIngressos(filtrados);
        }

        // --- A√á√ïES ---
        function excluirEvento(key) {
            if(confirm("Tem certeza que deseja apagar este evento? Isso n√£o apaga os ingressos j√° gerados.")) {
                db.ref('eventos/'+key).remove();
            }
        }

        function excluirIngresso(key) {
            if(confirm("Apagar este ingresso permanentemente?")) {
                db.ref('ingressos/'+key).remove();
            }
        }

        async function reenviarEmail(key) {
            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = "‚è≥...";
            btn.disabled = true;

            try {
                // 1. Pega dados do ingresso
                const snap = await db.ref('ingressos/'+key).once('value');
                if(!snap.exists()) throw new Error("Ingresso n√£o encontrado.");
                const t = snap.val();

                // 2. Precisa da imagem de fundo do evento para gerar
                // Vamos buscar o evento pelo NOME (n√£o √© ideal, mas √© como o banco est√° estruturado)
                const evSnap = await db.ref('eventos').orderByChild('nome').equalTo(t.evento).once('value');
                let bgUrl = null;
                if(evSnap.exists()) {
                    const evData = Object.values(evSnap.val())[0];
                    bgUrl = evData.bgPdf;
                }

                // 3. Carrega Imagem
                let imgBgElement = null;
                if(bgUrl) {
                    imgBgElement = new Image(); imgBgElement.crossOrigin = "Anonymous"; imgBgElement.src = bgUrl;
                    await new Promise((resolve) => { imgBgElement.onload = resolve; imgBgElement.onerror = resolve; });
                }

                // 4. Solicita E-mail do Respons√°vel (caso queira mudar ou confirmar)
                // Se quiser autom√°tico, use t.email se tiver salvo, mas o banco atual n√£o salva email no n√≥ do ingresso, apenas 'responsavel'
                // Vou pedir num prompt para garantir
                const emailDestino = prompt("Para qual e-mail enviar?", "");
                if(!emailDestino) { btn.innerText = originalText; btn.disabled = false; return; }

                // 5. Gera Imagem
                const base64Img = await gerarImagemAdmin(t.aluno, key, t.evento, imgBgElement);

                // 6. Envia
                await emailjs.send("service_r1vrjkp", "template_4yvqw5g", {
                    nome_responsavel: t.responsavel,
                    to_email: emailDestino,
                    evento: t.evento,
                    imagem_ingresso: base64Img,
                    message: "Reenvio pelo Admin"
                });

                alert("E-mail reenviado com sucesso!");

            } catch(e) {
                console.error(e);
                alert("Erro ao reenviar: " + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        // Funcao duplicada do index mas adaptada para o admin
        async function gerarImagemAdmin(alunoNome, idUnico, nomeEvento, fundoImgEl) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            const width = 200; const height = 300;
            canvas.width = width; canvas.height = height;

            ctx.fillStyle = '#ffffff'; ctx.fillRect(0, 0, width, height);

            if(fundoImgEl) {
                const ratio = Math.max(width / fundoImgEl.width, height / fundoImgEl.height);
                const centerShift_x = (width - fundoImgEl.width * ratio) / 2;
                const centerShift_y = (height - fundoImgEl.height * ratio) / 2;
                ctx.drawImage(fundoImgEl, 0, 0, fundoImgEl.width, fundoImgEl.height, centerShift_x, centerShift_y, fundoImgEl.width * ratio, fundoImgEl.height * ratio);
            }

            const boxW = 180; const boxH = 160;
            const boxX = (width - boxW) / 2; const boxY = (height - boxH) / 2 + 30;
            ctx.fillStyle = 'rgba(255, 255, 255, 0.92)';
            ctx.beginPath(); ctx.roundRect(boxX, boxY, boxW, boxH, 15); ctx.fill();

            ctx.fillStyle = '#1e293b'; ctx.textAlign = 'center';
            ctx.font = 'bold 12px sans-serif';
            ctx.fillText(nomeEvento.substring(0, 20), width/2, boxY + 25);

            let fontSizeAluno = 16;
            ctx.font = `900 ${fontSizeAluno}px sans-serif`;
            ctx.fillStyle = '#000000';
            const nomeUp = alunoNome.toUpperCase();
            while (ctx.measureText(nomeUp).width > boxW - 10 && fontSizeAluno > 8) {
                 fontSizeAluno--; ctx.font = `900 ${fontSizeAluno}px sans-serif`;
            }
            ctx.fillText(nomeUp, width/2, boxY + 50);

            ctx.font = '10px monospace'; ctx.fillStyle = '#64748b';
            ctx.fillText(`ID: ${idUnico}`, width/2, boxY + 68);

            const qrSize = 80;
            const qrDiv = document.createElement('div');
            new QRCode(qrDiv, { text: idUnico, width: qrSize, height: qrSize, correctLevel : QRCode.CorrectLevel.L });
            await new Promise(r => setTimeout(r, 150)); 
            const qrCanvas = qrDiv.querySelector('canvas');
            if(qrCanvas) ctx.drawImage(qrCanvas, (width - qrSize)/2, boxY + 75);

            return canvas.toDataURL('image/jpeg', 0.7); 
        }
    </script>
</body>
</html>
