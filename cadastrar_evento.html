<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Admin - ESCOLAPRO</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
</head>
<body class="bg-slate-100 font-sans pb-20">

    <nav class="bg-slate-900 text-white p-4 px-8 flex justify-between items-center shadow-lg">
        <div class="font-black italic text-xl">ESCOLAPRO <span class="text-blue-400">ADMIN</span></div>
        <div class="flex gap-3">
            <a href="index.html" class="px-4 py-2 bg-slate-700 rounded-lg text-xs font-bold hover:bg-slate-600 transition">üè† In√≠cio</a>
            <a href="validar.html" class="px-4 py-2 bg-blue-600 rounded-lg text-xs font-bold hover:bg-blue-500 transition">üì∑ Validar</a>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto p-6 grid grid-cols-1 lg:grid-cols-3 gap-8 mt-4">

        <div class="space-y-8">
            
            <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-200">
                <h3 class="font-black text-slate-800 text-lg mb-4 flex items-center gap-2">üìÖ Criar Evento</h3>
                <div class="space-y-3">
                    <input id="evNome" type="text" placeholder="Nome do Evento" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    <input id="evData" type="text" placeholder="Data (Ex: 25/10)" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    <input id="evQtd" type="number" placeholder="Ingressos p/ cadastro (Padr√£o: 1)" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    <input id="evImg" type="text" placeholder="Link Imagem Capa" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    <input id="evBg" type="text" placeholder="Link Fundo PDF (Opcional)" class="w-full p-3 bg-slate-50 rounded-xl text-sm outline-none focus:ring-2 ring-blue-500">
                    
                    <div class="p-3 bg-yellow-50 rounded-xl border border-yellow-200">
                        <p class="text-xs font-bold text-yellow-700 mb-1">√â evento pago?</p>
                        <input id="evZap" type="text" placeholder="Zap (Ex: 5511999999999)" class="w-full bg-white p-2 rounded-lg text-sm outline-none border border-yellow-300">
                    </div>

                    <button onclick="salvarEvento()" class="w-full bg-slate-900 text-white py-3 rounded-xl font-bold hover:bg-black transition">Salvar Evento</button>
                </div>
            </div>

            <div class="bg-green-50 p-6 rounded-3xl border border-green-100">
                <h3 class="font-black text-green-800 text-lg mb-4 flex items-center gap-2">üìÇ Banco de Alunos</h3>
                <p class="text-xs text-green-600 mb-2">Cole aqui o JSON gerado do Excel.</p>
                <textarea id="jsonAlunos" rows="5" class="w-full p-3 rounded-xl text-xs font-mono outline-none border border-green-200" placeholder='Ex: [{"matricula":"101", "nome":"JOAO", "turma":"1A"}, ...]'></textarea>
                <button onclick="importarAlunos()" class="w-full mt-2 bg-green-600 text-white py-3 rounded-xl font-bold hover:bg-green-700 transition">Importar Lista</button>
            </div>

            <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100">
                <h3 class="font-black text-blue-800 text-lg mb-4 flex items-center gap-2">üéüÔ∏è Ingresso Avulso</h3>
                <div class="space-y-3">
                    <select id="selEventos" class="w-full p-3 bg-white rounded-xl text-sm outline-none text-slate-700 font-bold"><option>Carregando...</option></select>
                    <input id="avMat" type="number" placeholder="Matr√≠cula" class="w-full p-3 bg-white rounded-xl text-sm outline-none" onblur="buscarAlunoAvulso(this.value)">
                    <input id="avAluno" type="text" placeholder="Nome (Autom√°tico)" class="w-full p-3 bg-white rounded-xl text-sm outline-none font-bold text-blue-800">
                    <input id="avResp" type="text" placeholder="Respons√°vel (Opcional)" class="w-full p-3 bg-white rounded-xl text-sm outline-none">
                    <button onclick="gerarAvulso()" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold hover:bg-blue-700 transition">Gerar & Baixar</button>
                </div>
            </div>

        </div>

        <div class="lg:col-span-2 space-y-6">
            <div class="grid grid-cols-2 gap-4">
                <div class="bg-white p-4 rounded-2xl shadow-sm"><p class="text-xs font-bold text-gray-400">Total Emitidos</p><h2 id="totalGeral" class="text-3xl font-black text-slate-800">0</h2></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm"><p class="text-xs font-bold text-gray-400">Validados</p><h2 id="totalValidados" class="text-3xl font-black text-green-500">0</h2></div>
            </div>

            <div class="bg-white rounded-3xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h3 class="font-black text-slate-800 text-lg">Passageiros</h3>
                    <input type="text" id="busca" onkeyup="filtrarTabela()" placeholder="üîç Buscar..." class="p-2 bg-gray-50 rounded-lg text-sm border">
                </div>
                <div class="overflow-x-auto"><table class="w-full text-left text-sm text-gray-600"><tbody id="tabelaIngressos"><tr><td class="p-4">Carregando...</td></tr></tbody></table></div>
            </div>
        </div>
    </div>

    <div id="qrcode-temp" style="display:none"></div>

    <script>
        // CONFIGURA√á√ÉO FIREBASE
        const firebaseConfig = { 
            apiKey: "AIzaSyBFDlEOhuUerWjSfK_mPVxoj5sGbSDhe9k", 
            authDomain: "ingressoscdc-9ce88.firebaseapp.com", 
            databaseURL: "https://ingressoscdc-9ce88-default-rtdb.firebaseio.com", 
            projectId: "ingressoscdc-9ce88", 
            storageBucket: "ingressoscdc-9ce88.firebasestorage.app", 
            messagingSenderId: "976193676383", 
            appId: "1:976193676383:web:8f141a1bd705f8bc0ae7ea" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 1. IMPORTAR ALUNOS
        function importarAlunos() {
            const jsonText = document.getElementById('jsonAlunos').value;
            try {
                const lista = JSON.parse(jsonText);
                if(!Array.isArray(lista)) throw new Error("O formato deve ser uma lista []");

                let updates = {};
                lista.forEach(aluno => {
                    // A chave ser√° a matr√≠cula para busca r√°pida
                    if(aluno.matricula && aluno.nome) {
                        updates['/alunos_db/' + aluno.matricula] = {
                            nome: aluno.nome,
                            turma: aluno.turma || ""
                        };
                    }
                });

                db.ref().update(updates)
                  .then(() => alert(`Sucesso! ${lista.length} alunos importados/atualizados.`))
                  .catch(e => alert("Erro ao salvar: " + e.message));

            } catch(e) {
                alert("Erro no formato JSON! Certifique-se que est√° correto.\n" + e.message);
            }
        }

        // 2. BUSCA AUTOM√ÅTICA NO INGRESSO AVULSO
        async function buscarAlunoAvulso(mat) {
            if(!mat) return;
            const snap = await db.ref('alunos_db/' + mat).once('value');
            if(snap.exists()) {
                document.getElementById('avAluno').value = snap.val().nome;
            } else {
                alert("Aluno n√£o encontrado no banco de dados.");
                document.getElementById('avAluno').value = "";
            }
        }

        // --- MANTENDO AS FUN√á√ïES ANTIGAS ---
        let todosEventos = {}; let todosIngressos = [];

        db.ref('eventos').on('value', snap => {
            const sel = document.getElementById('selEventos'); sel.innerHTML = ""; todosEventos = {};
            snap.forEach(i => {
                const ev = i.val(); todosEventos[ev.nome] = ev;
                const opt = document.createElement('option'); opt.value = ev.nome; opt.text = ev.nome; sel.appendChild(opt);
            });
        });

        db.ref('ingressos').on('value', snap => {
            const tbody = document.getElementById('tabelaIngressos'); tbody.innerHTML = ""; todosIngressos = [];
            let qtd = 0; let val = 0;
            if(!snap.exists()) return;
            const lista = []; snap.forEach(item => lista.push({ key: item.key, ...item.val() }));
            lista.reverse().forEach(ing => {
                qtd++; if(ing.utilizado) val++; todosIngressos.push(ing);
                const status = ing.utilizado ? 'USADO' : 'ATIVO';
                const tr = document.createElement('tr');
                tr.innerHTML = `<td class="p-4 font-bold">${ing.aluno}<br><span class="text-xs font-normal">Mat: ${ing.matricula}</span></td><td class="p-4 uppercase">${ing.evento}</td><td class="p-4 font-bold text-xs">${status}</td><td class="p-4 text-right"><button onclick="reimprimir('${ing.key}')" class="bg-slate-800 text-white px-2 py-1 rounded text-xs">PDF</button></td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('totalGeral').innerText = qtd; document.getElementById('totalValidados').innerText = val;
        });

        function salvarEvento() {
            const nome = document.getElementById('evNome').value;
            const data = document.getElementById('evData').value;
            const img = document.getElementById('evImg').value;
            const bgPdf = document.getElementById('evBg').value;
            const qtd = document.getElementById('evQtd').value || 1;
            const zap = document.getElementById('evZap').value;
            if(!nome || !data) return alert("Preencha dados!");
            db.ref('eventos').push({ nome, data, imagem: img, bgPdf, qtd: qtd, contato: zap });
            alert("Evento criado!"); document.getElementById('evNome').value = "";
        }

        async function gerarAvulso() {
            const evNome = document.getElementById('selEventos').value;
            const aluno = document.getElementById('avAluno').value;
            const mat = document.getElementById('avMat').value;
            const resp = document.getElementById('avResp').value || "Escola";
            if(!aluno || !mat) return alert("Preencha dados!");
            const idUnico = `${mat}-AVULSO-${Date.now().toString().slice(-4)}`;
            await db.ref('ingressos/' + idUnico).set({ aluno, matricula: mat, responsavel: resp, evento: evNome, utilizado: false, dataGeracao: new Date().toISOString() });
            reimprimir(idUnico, { key: idUnico, aluno, matricula: mat, evento: evNome });
            document.getElementById('avMat').value = ""; document.getElementById('avAluno').value = "";
        }

        async function reimprimir(key, dadosDiretos = null) {
            let dados = dadosDiretos || todosIngressos.find(i => i.key === key);
            if(!dados) return alert("Erro local.");
            const evInfo = todosEventos[dados.evento];
            let fundoImg = await carregarImagemSegura(evInfo?.bgPdf);
            
            const { jsPDF } = window.jspdf; const doc = new jsPDF();
            if(fundoImg) { doc.addImage(fundoImg, 'JPEG', 0, 0, 210, 297); doc.setFillColor(255, 255, 255); doc.roundedRect(60, 70, 90, 100, 5, 5, 'F'); }
            doc.text(dados.aluno.toUpperCase(), 105, 85, {align: 'center', maxWidth: 80});
            doc.setFontSize(10); doc.text(`ID: ${key}`, 105, 97, {align: 'center'});
            
            const qrDiv = document.getElementById('qrcode-temp'); qrDiv.innerHTML = "";
            new QRCode(qrDiv, { text: key, width: 256, height: 256 });
            await new Promise(r => setTimeout(r, 100));
            const qrCanvas = qrDiv.querySelector('canvas');
            if(qrCanvas) doc.addImage(qrCanvas.toDataURL("image/png"), 'PNG', 75, 110, 60, 60);
            doc.save(`Ingresso_${dados.aluno}.pdf`);
        }

        function carregarImagemSegura(url) { return new Promise((r) => { if(!url) return r(null); const i = new Image(); i.crossOrigin="anonymous"; i.onload=()=> {const c=document.createElement("canvas");c.width=i.width;c.height=i.height;c.getContext("2d").drawImage(i,0,0);r(c.toDataURL("image/jpeg",0.7))}; i.onerror=()=>r(null); i.src=url; }); }
        function filtrarTabela() { const t = document.getElementById('busca').value.toLowerCase(); document.querySelectorAll('#tabelaIngressos tr').forEach(l => l.style.display = l.innerText.toLowerCase().includes(t)?'':'none'); }
    </script>
</body>
</html>
