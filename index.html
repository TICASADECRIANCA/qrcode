<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ingressos Escola</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <style>
        .grayscale-card { filter: grayscale(100%); opacity: 0.8; }
    </style>
</head>
<body class="bg-slate-50 font-sans pb-20">

    <div class="bg-blue-900 text-white p-6 shadow-lg rounded-b-3xl mb-8 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cube-coat.png')]"></div>
        <div class="relative z-10 text-center">
            <h1 class="text-2xl font-black italic tracking-tighter">ESCOLAPRO <span class="text-blue-300">EVENTOS</span></h1>
            <p class="text-blue-200 text-xs mt-1 font-medium uppercase tracking-widest">Portal do Aluno</p>
        </div>
    </div>

    <div id="eventosContainer" class="max-w-md mx-auto px-6 space-y-6">
        <p class="text-center text-gray-400 text-sm animate-pulse mt-10">Carregando eventos dispon√≠veis...</p>
    </div>

    <div id="modalIngresso" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center z-50 backdrop-blur-sm p-4 transition-opacity duration-300">
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl relative transform scale-100 transition-transform duration-300">
            
            <button onclick="fecharModal()" class="absolute top-4 right-4 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center font-bold text-gray-500 hover:bg-gray-200 z-10">‚úï</button>
            
            <div class="p-8 pt-10 text-center">
                <div class="mb-4 inline-block p-3 rounded-full bg-blue-50 text-blue-600 text-2xl">üéüÔ∏è</div>
                <h3 class="text-xl font-black text-slate-800 mb-1 leading-tight" id="mdEvento">Nome do Evento</h3>
                <p class="text-xs text-gray-500 mb-6 font-medium uppercase tracking-wide">√Årea do Aluno</p>
                
                <div class="space-y-4">
                    <div class="text-left">
                        <label class="text-[10px] font-bold text-gray-400 ml-2">SUA MATR√çCULA</label>
                        <input type="number" id="inputMatricula" placeholder="Digite aqui..." class="w-full bg-slate-50 border border-slate-200 p-4 rounded-xl text-center text-xl font-black text-slate-700 outline-none focus:ring-4 ring-blue-100 transition-all placeholder:font-normal">
                    </div>

                    <button onclick="gerarIngresso()" id="btnGerar" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 active:scale-95 transition shadow-lg shadow-blue-200">
                        GARANTIR AGORA
                    </button>
                </div>
            </div>
            
            <div class="bg-slate-50 p-3 text-center text-[10px] text-gray-400 font-bold uppercase tracking-widest border-t border-slate-100">
                Sistema Oficial EscolaPro
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURA√á√ÉO FIREBASE ---
        const firebaseConfig = { 
            apiKey: "AIzaSyBFDlEOhuUerWjSfK_mPVxoj5sGbSDhe9k", 
            authDomain: "ingressoscdc-9ce88.firebaseapp.com", 
            databaseURL: "https://ingressoscdc-9ce88-default-rtdb.firebaseio.com", 
            projectId: "ingressoscdc-9ce88", 
            storageBucket: "ingressoscdc-9ce88.firebasestorage.app", 
            messagingSenderId: "976193676383", 
            appId: "1:976193676383:web:8f141a1bd705f8bc0ae7ea" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        let eventoSelecionado = null;

        // --- 1. CARREGAR EVENTOS ---
        db.ref('eventos').on('value', (snapshot) => {
            const container = document.getElementById('eventosContainer');
            container.innerHTML = "";

            if (!snapshot.exists()) {
                container.innerHTML = `
                    <div class="text-center mt-10 opacity-50">
                        <div class="text-4xl mb-2">üìÖ</div>
                        <p class="font-bold text-slate-400">Nenhum evento no momento.</p>
                    </div>`;
                return;
            }

            snapshot.forEach((childSnapshot) => {
                const evento = childSnapshot.val();
                const key = childSnapshot.key;
                
                // --- L√ìGICA DA VITRINE (BLOQUEIO) ---
                const isLocked = evento.liberado === false;
                
                let botaoHtml = "";
                let estiloCard = "";
                let statusBadge = "";

                if(isLocked) {
                    // MODO VITRINE (Bloqueado)
                    botaoHtml = `
                        <button disabled class="w-full bg-slate-100 text-slate-400 py-3 rounded-xl font-bold text-sm cursor-not-allowed flex items-center justify-center gap-2 border border-slate-200">
                            üîí EM BREVE
                        </button>`;
                    estiloCard = "grayscale-card"; 
                    statusBadge = `<div class="absolute top-2 left-2 bg-slate-800/80 backdrop-blur px-3 py-1 rounded-lg text-[10px] font-bold text-white shadow-sm uppercase tracking-wide">Aguarde</div>`;
                } else {
                    // MODO VENDA (Liberado)
                    botaoHtml = `
                        <button onclick="abrirModal('${evento.nome}', '${key}')" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-sm hover:bg-blue-700 transition shadow-lg shadow-blue-200 flex items-center justify-center gap-2 group">
                            <span>GARANTIR INGRESSO</span>
                            <span class="group-hover:translate-x-1 transition">‚ûî</span>
                        </button>`;
                    estiloCard = "";
                    statusBadge = `<div class="absolute top-2 left-2 bg-green-500 px-3 py-1 rounded-lg text-[10px] font-bold text-white shadow-sm uppercase tracking-wide animate-pulse">Liberado</div>`;
                }

                container.innerHTML += `
                    <div class="bg-white p-5 rounded-3xl shadow-sm border border-slate-100 ${estiloCard} transition duration-500 hover:shadow-md">
                        <div class="relative h-44 rounded-2xl overflow-hidden mb-4 bg-gray-200 shadow-inner">
                            <img src="${evento.imagem || 'https://via.placeholder.com/400x200?text=Evento'}" class="w-full h-full object-cover">
                            ${statusBadge}
                            <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur px-3 py-1 rounded-lg text-xs font-black text-slate-800 shadow-sm border border-white/50">
                                üìÖ ${evento.data}
                            </div>
                        </div>
                        <h2 class="text-xl font-black text-slate-800 leading-tight mb-4 pr-2">${evento.nome}</h2>
                        ${botaoHtml}
                    </div>
                `;
            });
        });

        // --- 2. FUN√á√ïES DO MODAL ---
        function abrirModal(nome, key) {
            eventoSelecionado = nome;
            document.getElementById('mdEvento').innerText = nome;
            document.getElementById('modalIngresso').classList.remove('hidden');
            document.getElementById('modalIngresso').classList.add('flex');
            setTimeout(() => document.getElementById('inputMatricula').focus(), 100);
        }

        function fecharModal() {
            document.getElementById('modalIngresso').classList.add('hidden');
            document.getElementById('modalIngresso').classList.remove('flex');
            document.getElementById('inputMatricula').value = "";
        }

        // --- 3. GERAR INGRESSO (COM TRAVA DE DUPLICIDADE) ---
        async function gerarIngresso() {
            const mat = document.getElementById('inputMatricula').value.trim();
            const btn = document.getElementById('btnGerar');
            
            if(!mat) {
                Swal.fire({ icon: 'warning', title: 'Aten√ß√£o', text: 'Digite sua matr√≠cula!', confirmButtonColor: '#2563EB' });
                return;
            }
            
            // Efeito de Carregamento
            const textoOriginal = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block mr-2">‚Üª</span> Processando...`;
            btn.disabled = true;

            try {
                // A. Verifica se o aluno existe
                const snapAluno = await db.ref('alunos_db/'+mat).once('value');
                
                if(!snapAluno.exists()) {
                    Swal.fire({ icon: 'error', title: 'N√£o encontrado', text: 'Matr√≠cula n√£o cadastrada no sistema.', confirmButtonColor: '#EF4444' });
                    restaurarBotao(btn, textoOriginal);
                    return;
                }
                
                const dadosAluno = snapAluno.val();
                const nomeAluno = dadosAluno.nome;

                // B. VERIFICA SE J√Å POSSUI INGRESSO (A TRAVA DE DUPLICIDADE)
                // Pesquisa nos ingressos se existe algum com essa matr√≠cula E esse evento
                const checkSnap = await db.ref('ingressos').orderByChild('matricula').equalTo(mat).once('value');
                let jaTem = false;
                
                if(checkSnap.exists()) {
                    checkSnap.forEach(child => {
                        if(child.val().evento === eventoSelecionado) {
                            jaTem = true;
                        }
                    });
                }

                if(jaTem) {
                    Swal.fire({ 
                        icon: 'info', 
                        title: 'J√° garantido!', 
                        text: `Ol√° ${nomeAluno.split(' ')[0]}, voc√™ j√° garantiu seu ingresso para este evento!`,
                        confirmButtonColor: '#3B82F6' 
                    });
                    fecharModal();
                    restaurarBotao(btn, textoOriginal);
                    return;
                }

                // C. Tudo certo: Cria o Ingresso
                const id = `${mat}-${Date.now().toString().slice(-6)}`;
                await db.ref('ingressos/' + id).set({
                    aluno: nomeAluno,
                    matricula: mat,
                    turma: dadosAluno.turma || "N/A",
                    evento: eventoSelecionado,
                    tipo: 'Aluno', // N√£o consome estoque do avulso
                    utilizado: false,
                    data: new Date().toISOString()
                });

                // Sucesso
                fecharModal();
                Swal.fire({
                    icon: 'success',
                    title: 'Parab√©ns!',
                    html: `Ingresso confirmado para <b>${nomeAluno}</b>!<br><span style="font-size:12px; color:#666">Seu nome est√° na lista.</span>`,
                    confirmButtonColor: '#10B981'
                });

            } catch (error) {
                console.error(error);
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Erro de conex√£o. Tente novamente.' });
            }

            restaurarBotao(btn, textoOriginal);
        }

        function restaurarBotao(btn, html) {
            btn.innerHTML = html;
            btn.disabled = false;
        }
    </script>
</body>
</html>
