<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CASAQR - EVENTOS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <style>
        .grayscale-card { filter: grayscale(100%); opacity: 0.8; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Estilo fixo para o Card que ser√° transformado em Imagem */
        #renderContainer {
            position: fixed;
            top: -9999px;
            left: -9999px;
            z-index: -10;
        }
        .ticket-design {
            width: 400px; /* Largura fixa para o JPG */
            background-color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            position: relative;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans pb-20 overflow-x-hidden">

    <div class="bg-blue-900 text-white p-6 shadow-lg rounded-b-3xl mb-6 relative overflow-hidden">
        <div class="absolute top-0 left-0 w-full h-full opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cube-coat.png')]"></div>
        <div class="relative z-10 text-center">
            <h1 class="text-2xl font-black italic tracking-tighter">CASAQR<span class="text-blue-300">EVENTOS</span></h1>
            <p class="text-blue-200 text-xs mt-1 font-medium uppercase tracking-widest">Portal do Aluno</p>
        </div>
    </div>

    <div class="px-6 mb-4">
        <h2 class="text-slate-800 font-bold text-lg">Pr√≥ximos Eventos</h2>
    </div>

    <div id="eventosContainer" class="flex overflow-x-auto gap-4 px-6 pb-8 snap-x snap-mandatory no-scrollbar w-full">
        <p class="text-center text-gray-400 text-sm animate-pulse mt-4 w-full">Carregando eventos...</p>
    </div>

    <div id="modalIngresso" class="fixed inset-0 bg-slate-900/90 hidden items-center justify-center z-50 backdrop-blur-sm p-4 transition-opacity duration-300">
        <div class="bg-white rounded-3xl w-full max-w-sm overflow-hidden shadow-2xl relative transform scale-100 transition-transform duration-300 max-h-[90vh] overflow-y-auto">
            <button onclick="fecharModal()" class="absolute top-4 right-4 bg-gray-100 rounded-full w-8 h-8 flex items-center justify-center font-bold text-gray-500 hover:bg-gray-200 z-10">‚úï</button>
            <div class="p-6 pt-10 text-center">
                <div class="mb-2 inline-block p-3 rounded-full bg-blue-50 text-blue-600 text-2xl">üéüÔ∏è</div>
                <h3 class="text-xl font-black text-slate-800 mb-1 leading-tight" id="mdEvento">Nome do Evento</h3>
                <p class="text-xs text-blue-600 bg-blue-50 py-1 px-3 rounded-full inline-block mb-4 font-bold uppercase tracking-wide" id="mdQtdInfo">1 Ingresso por aluno</p>
                
                <div class="space-y-3 text-left">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 ml-2">MATR√çCULA</label>
                        <input type="number" id="inputMatricula" onblur="verificarAluno()" placeholder="Ex: 102030" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl font-bold text-slate-700 outline-none focus:ring-2 ring-blue-500 transition-all">
                        <div id="feedbackAluno" class="mt-1 text-xs font-bold hidden px-2"></div>
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 ml-2">NOME DO RESPONS√ÅVEL</label>
                        <input type="text" id="inputResponsavel" placeholder="Quem est√° solicitando?" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm text-slate-700 outline-none focus:ring-2 ring-blue-500">
                    </div>
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 ml-2">EMAIL</label>
                        <input type="email" id="inputEmail" placeholder="seuemail@exemplo.com" class="w-full bg-slate-50 border border-slate-200 p-3 rounded-xl text-sm text-slate-700 outline-none focus:ring-2 ring-blue-500">
                    </div>
                    <button onclick="gerarIngresso()" id="btnGerar" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg hover:bg-blue-700 active:scale-95 transition shadow-lg shadow-blue-200 mt-2">
                        GARANTIR & BAIXAR JPG
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="renderContainer"></div>

    <script>
        // --- CONFIGURA√á√ïES ---
        const firebaseConfig = { 
            apiKey: "AIzaSyBFDlEOhuUerWjSfK_mPVxoj5sGbSDhe9k", 
            authDomain: "ingressoscdc-9ce88.firebaseapp.com", 
            databaseURL: "https://ingressoscdc-9ce88-default-rtdb.firebaseio.com", 
            projectId: "ingressoscdc-9ce88", 
            storageBucket: "ingressoscdc-9ce88.firebasestorage.app", 
            messagingSenderId: "976193676383", 
            appId: "1:976193676383:web:8f141a1bd705f8bc0ae7ea" 
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        emailjs.init("RmJx_2rhtntD90vsH"); 

        let eventoSelecionado = null;
        let limiteIngressosEvento = 1;
        let dadosAlunoEncontrado = null; 

        // --- CARREGAR EVENTOS ---
        db.ref('eventos').on('value', (snapshot) => {
            const container = document.getElementById('eventosContainer');
            container.innerHTML = "";
            if (!snapshot.exists()) {
                container.innerHTML = `<div class="w-full text-center mt-4 opacity-50"><p class="font-bold text-slate-400">Nenhum evento.</p></div>`;
                return;
            }
            snapshot.forEach((childSnapshot) => {
                const evento = childSnapshot.val();
                const key = childSnapshot.key;
                const isLocked = evento.liberado === false;
                const limite = evento.limit_ingressos || 1; 
                
                let botaoHtml = "";
                let estiloCard = "";
                let statusBadge = "";

                if(isLocked) {
                    botaoHtml = `<button disabled class="w-full bg-slate-100 text-slate-400 py-3 rounded-xl font-bold text-sm cursor-not-allowed flex items-center justify-center gap-2 border border-slate-200">üîí EM BREVE</button>`;
                    estiloCard = "grayscale-card"; 
                    statusBadge = `<div class="absolute top-2 left-2 bg-slate-800/80 backdrop-blur px-3 py-1 rounded-lg text-[10px] font-bold text-white shadow-sm uppercase tracking-wide">Aguarde</div>`;
                } else {
                    botaoHtml = `<button onclick="abrirModal('${evento.nome}', '${key}', ${limite})" class="w-full bg-blue-600 text-white py-3 rounded-xl font-bold text-sm hover:bg-blue-700 transition shadow-lg shadow-blue-200 group"><span>GARANTIR</span></button>`;
                    estiloCard = "";
                    statusBadge = `<div class="absolute top-2 left-2 bg-green-500 px-3 py-1 rounded-lg text-[10px] font-bold text-white shadow-sm uppercase tracking-wide animate-pulse">Liberado</div>`;
                }

                container.innerHTML += `
                    <div class="min-w-[85%] md:min-w-[350px] snap-center shrink-0 bg-white p-4 rounded-3xl shadow-sm border border-slate-100 ${estiloCard} transition duration-300">
                        <div class="relative h-44 rounded-2xl overflow-hidden mb-4 bg-gray-200 shadow-inner">
                            <img src="${evento.imagem || 'https://via.placeholder.com/400x200?text=Evento'}" class="w-full h-full object-cover">
                            ${statusBadge}
                            <div class="absolute bottom-2 right-2 bg-white/90 backdrop-blur px-3 py-1 rounded-lg text-xs font-black text-slate-800 shadow-sm border border-white/50">
                                üìÖ ${evento.data}
                            </div>
                        </div>
                        <h2 class="text-xl font-black text-slate-800 leading-tight mb-4 truncate">${evento.nome}</h2>
                        ${botaoHtml}
                    </div>
                `;
            });
        });

        function abrirModal(nome, key, limite) {
            eventoSelecionado = nome;
            limiteIngressosEvento = parseInt(limite) || 1;
            
            document.getElementById('mdEvento').innerText = nome;
            const textoQtd = limiteIngressosEvento > 1 ? `Voc√™ receber√° ${limiteIngressosEvento} ingressos` : `1 Ingresso por aluno`;
            document.getElementById('mdQtdInfo').innerText = textoQtd;

            document.getElementById('modalIngresso').classList.remove('hidden');
            document.getElementById('modalIngresso').classList.add('flex');
        }

        function fecharModal() {
            document.getElementById('modalIngresso').classList.add('hidden');
            document.getElementById('modalIngresso').classList.remove('flex');
            document.getElementById('inputMatricula').value = "";
            document.getElementById('inputResponsavel').value = "";
            document.getElementById('inputEmail').value = "";
            document.getElementById('feedbackAluno').classList.add('hidden');
            dadosAlunoEncontrado = null;
        }

        async function verificarAluno() {
            const mat = document.getElementById('inputMatricula').value.trim();
            const feed = document.getElementById('feedbackAluno');
            if(!mat) { feed.classList.add('hidden'); dadosAlunoEncontrado = null; return; }
            feed.innerHTML = "üîç Buscando...";
            feed.className = "mt-1 text-xs font-bold px-2 text-blue-500 block";
            try {
                const snap = await db.ref('alunos_db/'+mat).once('value');
                if(snap.exists()) {
                    const d = snap.val();
                    dadosAlunoEncontrado = { nome: d.nome, turma: d.turma || "N/A" };
                    feed.innerHTML = `‚úÖ ${d.nome} (${d.turma})`;
                    feed.className = "mt-1 text-xs font-bold px-2 text-green-600 block";
                } else {
                    dadosAlunoEncontrado = null;
                    feed.innerHTML = `‚ùå Matr√≠cula n√£o encontrada`;
                    feed.className = "mt-1 text-xs font-bold px-2 text-red-500 block";
                }
            } catch(e) { console.error(e); }
        }

        async function gerarIngresso() {
            const mat = document.getElementById('inputMatricula').value.trim();
            const resp = document.getElementById('inputResponsavel').value.trim();
            const email = document.getElementById('inputEmail').value.trim();
            const btn = document.getElementById('btnGerar');

            if(!mat || !resp || !email) return Swal.fire({ icon: 'warning', title: 'Faltam dados', text: 'Preencha todos os campos.' });

            const textoOriginal = btn.innerHTML;
            btn.innerHTML = `<span class="animate-spin inline-block mr-2">‚Üª</span> Processando...`;
            btn.disabled = true;

            try {
                // 1. Valida√ß√£o
                if (!dadosAlunoEncontrado) {
                    const snapCheck = await db.ref('alunos_db/'+mat).once('value');
                    if(snapCheck.exists()) {
                        const d = snapCheck.val();
                        dadosAlunoEncontrado = { nome: d.nome, turma: d.turma || "N/A" };
                    } else {
                        Swal.fire({ icon: 'error', title: 'N√£o encontrado', text: 'Matr√≠cula inv√°lida.' });
                        restaurarBotao(btn, textoOriginal); return;
                    }
                }

                const checkSnap = await db.ref('ingressos').orderByChild('matricula').equalTo(mat).once('value');
                let jaTem = false;
                if(checkSnap.exists()) {
                    checkSnap.forEach(c => { if(c.val().evento === eventoSelecionado) jaTem = true; });
                }

                if(jaTem) {
                    Swal.fire({ icon: 'info', title: 'J√° garantido', text: `Este aluno j√° garantiu seus ingressos.` });
                    fecharModal(); restaurarBotao(btn, textoOriginal); return;
                }

                // 2. Loop para Gerar e Baixar JPGs
                const baseId = `${mat}-${Date.now().toString().slice(-6)}`;
                let codigosGerados = [];
                const renderContainer = document.getElementById('renderContainer');
                
                // Exibe alerta inicial
                const Toast = Swal.mixin({ toast: true, position: 'top-end', showConfirmButton: false, timer: 3000 });
                Toast.fire({ icon: 'success', title: 'Gerando imagens...' });

                for (let i = 1; i <= limiteIngressosEvento; i++) {
                    const idIngresso = `${baseId}-${i}`;
                    codigosGerados.push(idIngresso);

                    // Salva no DB
                    await db.ref('ingressos/' + idIngresso).set({
                        aluno: dadosAlunoEncontrado.nome,
                        turma: dadosAlunoEncontrado.turma,
                        matricula: mat,
                        responsavel: resp,
                        email: email,
                        evento: eventoSelecionado,
                        numero_ingresso: i,
                        total_ingressos: limiteIngressosEvento,
                        data: new Date().toISOString()
                    });

                    // Cria o HTML do Ticket para ser fotografado
                    // Note que este HTML √© estilizado especificamente para virar imagem (tamanho fixo)
                    const htmlTicket = `
                        <div class="ticket-design" style="padding: 20px; border: 2px solid #1e40af; border-radius: 15px; background: linear-gradient(135deg, #ffffff 0%, #eff6ff 100%);">
                            
                            <div style="background: #1e3a8a; color: white; padding: 15px; border-radius: 10px 10px 0 0; text-align: center;">
                                <h1 style="margin:0; font-size: 22px; font-weight: 900; text-transform: uppercase;">${eventoSelecionado}</h1>
                                <p style="margin:0; font-size: 10px; letter-spacing: 2px;">ESCOLAPRO EVENTOS</p>
                            </div>

                            <div style="padding: 20px;">
                                <div style="margin-bottom: 15px;">
                                    <p style="font-size: 10px; color: #64748b; font-weight: bold; margin-bottom: 2px;">ALUNO(A)</p>
                                    <p style="font-size: 18px; font-weight: bold; color: #1e293b; margin: 0; line-height: 1.2;">${dadosAlunoEncontrado.nome}</p>
                                    <p style="font-size: 12px; color: #475569;">${dadosAlunoEncontrado.turma}</p>
                                </div>

                                <div style="margin-bottom: 15px;">
                                    <p style="font-size: 10px; color: #64748b; font-weight: bold; margin-bottom: 2px;">RESPONS√ÅVEL</p>
                                    <p style="font-size: 14px; font-weight: 600; color: #1e293b; margin: 0;">${resp}</p>
                                </div>

                                <div style="border-top: 2px dashed #cbd5e1; margin: 15px 0;"></div>

                                <div style="display: flex; justify-content: space-between; align-items: end;">
                                    <div>
                                        <p style="font-size: 10px; color: #64748b; font-weight: bold;">C√ìDIGO DE VALIDA√á√ÉO</p>
                                        <p style="font-size: 14px; font-family: monospace; font-weight: bold; background: #e2e8f0; padding: 4px 8px; border-radius: 4px; display: inline-block; margin-top: 4px;">${idIngresso}</p>
                                    </div>
                                    <div style="text-align: right;">
                                        <div style="background: #22c55e; color: white; padding: 5px 10px; border-radius: 8px; font-size: 12px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                                            ${i} / ${limiteIngressosEvento}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style="background: #1e3a8a; height: 10px; width: 100%; position: absolute; bottom: 0; left: 0;"></div>
                        </div>
                    `;

                    renderContainer.innerHTML = htmlTicket;

                    // Converte para Canvas e baixa
                    // Aguarda 300ms para garantir renderiza√ß√£o de fontes
                    await new Promise(r => setTimeout(r, 300));
                    
                    const element = renderContainer.querySelector('.ticket-design');
                    const canvas = await html2canvas(element, { scale: 2, useCORS: true });
                    
                    // Cria link de download
                    const link = document.createElement('a');
                    link.download = `Ingresso-${dadosAlunoEncontrado.nome}-${i}.jpg`;
                    link.href = canvas.toDataURL('image/jpeg', 0.9);
                    link.click();
                    
                    renderContainer.innerHTML = ""; // Limpa para o pr√≥ximo
                }

                // 3. Email
                const templateParams = {
                    nome_aluno: dadosAlunoEncontrado.nome,
                    turma: dadosAlunoEncontrado.turma,
                    nome_responsavel: resp,
                    evento: eventoSelecionado,
                    codigo_ingresso: codigosGerados.join(', '),
                    to_email: email
                };
                emailjs.send("service_r1vrjkp", "template_4yvqw5g", templateParams).catch(err => console.error(err));

                fecharModal();
                Swal.fire({ 
                    icon: 'success', 
                    title: 'Pronto!', 
                    html: `Geramos <b>${limiteIngressosEvento} imagem(ns)</b>.<br>Verifique seus downloads!`,
                    confirmButtonColor: '#10B981'
                });

            } catch (error) {
                console.error("Erro:", error);
                Swal.fire({ icon: 'error', title: 'Erro', text: 'Erro ao gerar imagem.' });
            }
            restaurarBotao(btn, textoOriginal);
        }

        function restaurarBotao(btn, html) { btn.innerHTML = html; btn.disabled = false; }
    </script>
</body>
</html>
